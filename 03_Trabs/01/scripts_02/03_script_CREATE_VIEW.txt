--#############
--# AMD GXX
--#############



--==============
-- DB connection
--==============
\set dataBase db_medknow
;
\set userName postgres
;
\connect :dataBase :userName
;
--==========================
--==========================

DROP VIEW IF EXISTS view_dataset;

CREATE OR REPLACE VIEW view_dataset AS
SELECT 
    d.PatientID,
    d.OcularAge AS age,
    CASE 
        WHEN p.LensHardness IS NULL THEN 'hypermetrope'
        ELSE 'myope'
    END AS prescription,
    CASE 
        WHEN dd.DiseaseID = 1 THEN 'yes'
        ELSE 'no'
    END AS astigmatic,
    CASE 
        WHEN d.TearRate > 0.5 THEN 'normal'
        ELSE 'reduced'
    END AS tearrate,
    CASE 
        WHEN p.LensHardness IS NULL THEN 'none'
        WHEN p.LensHardness > 0.5 THEN 'hard'
        ELSE 'soft'
    END AS lenses
FROM Diagnosis d
JOIN Prescription p ON d.DiagnosisID = p.PrescriptionID
JOIN Diagnosis_Disease dd ON d.DiagnosisID = dd.DiagnosisID;


SELECT * FROM view_dataset;

-- SELECT * FROM Diagnosis;
-- SELECT * FROM Prescription;
-- SELECT * FROM Diagnosis_Disease;